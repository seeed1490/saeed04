<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ุงูุนููุฏ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>๐ ุฅุฏุงุฑุฉ ุงูุนููุฏ</h1>

  <!-- ูููู ุงุฎุชูุงุฑ ุงููุฑุน + ุจูุงูุงุช ุงููุณุชุฎุฏู -->
  <div id="component"></div>

  <table id="contracts-table">
    <thead>
      <tr>
        <th>ุฑูู ุงูุนูุฏ</th>
        <th>ุงููุญุฏุฉ</th>
        <th>ุงููุณุชุฃุฌุฑ</th>
        <th>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</th>
        <th>ุชุงุฑูุฎ ุงูููุงูุฉ</th>
        <th>ุงููููุฉ</th>
        <th>ุงูุญุงูุฉ</th>
        <th>ุงูุฅุฌุฑุงุกุงุช</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="actions" style="text-align:center;">
    <a href="add-contract.html" class="btn primary">โ ุฅุถุงูุฉ ุนูุฏ ุฌุฏูุฏ</a>
    <a href="expired-contracts.html" class="btn info">๐ ุฃุฑุดูู ุงูุนููุฏ ุงูููุชููุฉ</a>
  </div>

  <script type="module">
    import { initComponent } from './scripts/component.js';
    import { fetchJSON } from './scripts/utils.js';
    import { getSession } from './scripts/auth.js';
    import { guardButton } from './scripts/permissions.js';

    // ุชูุนูู ุงููููู ุงูููุญุฏ (ุงุฎุชูุงุฑ ุงููุฑุน + ุงูุตูุงุญูุงุช)
    initComponent("component", [
      { selector: ".btn.primary", section: "ุนููุฏ", action: "ุฅุถุงูุฉ" }
    ]);

    const session = getSession();

    async function loadContracts() {
      const contracts = await fetchJSON('data/contracts.json');
      const tenants = await fetchJSON('data/tenants.json');
      const units = await fetchJSON('data/units.json');

      // ููุชุฑุฉ ุงูุนููุฏ ุญุณุจ ุงููุฑุน ูุงูุญุงูุฉ
      const branchContracts = contracts.filter(c => c.branch === session.branch && c.status === "ุณุงุฑู");

      const tbody = document.querySelector('#contracts-table tbody');
      tbody.innerHTML = branchContracts.map(c => {
        const tenant = tenants.find(t => t.id === c.tenantId);
        const unit = units.find(u => u.id === c.unitId);
        return `
          <tr>
            <td>${c.id}</td>
            <td>${unit ? unit.name : c.unitId}</td>
            <td>${tenant ? tenant.name : c.tenantId}</td>
            <td>${c.startDate}</td>
            <td>${c.endDate}</td>
            <td>${c.amount.toLocaleString()} ุฑูุงู</td>
            <td>${c.status}</td>
            <td>
              <a href="contract-details.html?contract=${c.id}" class="btn info">ุนุฑุถ</a>
              <button class="btn warning">ุชุนุฏูู</button>
              <button class="btn danger">ุญุฐู</button>
            </td>
          </tr>
        `;
      }).join('');

      // ุชุทุจูู ุงูุตูุงุญูุงุช ุนูู ุงูุฃุฒุฑุงุฑ
      setTimeout(() => {
        document.querySelectorAll('.btn.warning').forEach(btn =>
          guardButton(btn, session.role, 'ุนููุฏ', 'ุชุนุฏูู')
        );
        document.querySelectorAll('.btn.danger').forEach(btn =>
          guardButton(btn, session.role, 'ุนููุฏ', 'ุญุฐู')
        );
      }, 500);
    }

    loadContracts();
  </script>
</body>
</html>
