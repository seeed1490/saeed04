<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ุฃุฑุดูู ุงูุนููุฏ ุงูููุชููุฉ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>๐ ุฃุฑุดูู ุงูุนููุฏ ุงูููุชููุฉ</h1>

  <!-- ูููู ุงุฎุชูุงุฑ ุงููุฑุน + ุจูุงูุงุช ุงููุณุชุฎุฏู -->
  <div id="component"></div>

  <table id="expired-contracts-table">
    <thead>
      <tr>
        <th>ุฑูู ุงูุนูุฏ</th>
        <th>ุงููุญุฏุฉ</th>
        <th>ุงููุณุชุฃุฌุฑ</th>
        <th>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</th>
        <th>ุชุงุฑูุฎ ุงูููุงูุฉ</th>
        <th>ุงููููุฉ</th>
        <th>ุงูุญุงูุฉ</th>
        <th>ุงูุฅุฌุฑุงุกุงุช</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="actions" style="text-align:center;">
    <a href="contracts.html" class="btn info">๐ ุฑุฌูุน ููุนููุฏ ุงูุณุงุฑูุฉ</a>
  </div>

  <script type="module">
    import { initComponent } from './scripts/component.js';
    import { fetchJSON } from './scripts/utils.js';
    import { getSession } from './scripts/auth.js';
    import { guardButton } from './scripts/permissions.js';

    // ุชูุนูู ุงููููู ุงูููุญุฏ
    initComponent("component", []);

    const session = getSession();

    async function loadExpiredContracts() {
      const contracts = await fetchJSON('data/contracts.json');
      const tenants = await fetchJSON('data/tenants.json');
      const units = await fetchJSON('data/units.json');

      // ููุชุฑุฉ ุงูุนููุฏ ุงูููุชููุฉ ุญุณุจ ุงููุฑุน
      const expiredContracts = contracts.filter(c => c.branch === session.branch && c.status === "ููุชูู");

      const tbody = document.querySelector('#expired-contracts-table tbody');
      tbody.innerHTML = expiredContracts.map(c => {
        const tenant = tenants.find(t => t.id === c.tenantId);
        const unit = units.find(u => u.id === c.unitId);
        return `
          <tr>
            <td>${c.id}</td>
            <td>${unit ? unit.name : c.unitId}</td>
            <td>${tenant ? tenant.name : c.tenantId}</td>
            <td>${c.startDate}</td>
            <td>${c.endDate}</td>
            <td>${c.amount.toLocaleString()} ุฑูุงู</td>
            <td>${c.status}</td>
            <td>
              <button class="btn primary renewBtn">๐ ุชุฌุฏูุฏ</button>
              <button class="btn danger archiveBtn">๐๏ธ ุฃุฑุดูุฉ</button>
            </td>
          </tr>
        `;
      }).join('');

      // ุชุทุจูู ุงูุตูุงุญูุงุช ุนูู ุงูุฃุฒุฑุงุฑ
      setTimeout(() => {
        document.querySelectorAll('.renewBtn').forEach(btn =>
          guardButton(btn, session.role, 'ุนููุฏ', 'ุชุฌุฏูุฏ')
        );
        document.querySelectorAll('.archiveBtn').forEach(btn =>
          guardButton(btn, session.role, 'ุนููุฏ', 'ุฃุฑุดูุฉ')
        );
      }, 500);
    }

    loadExpiredContracts();
  </script>
</body>
</html>
