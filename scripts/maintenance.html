<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>سجل الصيانة</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>🛠️ سجل الصيانة</h1>

  <!-- مكون اختيار الفرع + بيانات المستخدم -->
  <div id="component"></div>

  <table id="maintenance-table">
    <thead>
      <tr>
        <th>رقم الطلب</th>
        <th>الوحدة</th>
        <th>المستأجر</th>
        <th>الوصف</th>
        <th>التاريخ</th>
        <th>الحالة</th>
        <th>الإجراءات</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="actions" style="text-align:center;">
    <a href="add-maintenance.html" class="btn primary">➕ إضافة طلب صيانة</a>
    <button id="printBtn" class="btn info">🖨️ طباعة السجل</button>
  </div>

  <script type="module">
    import { initComponent } from './scripts/component.js';
    import { fetchJSON, statusClass } from './scripts/utils.js';
    import { getSession } from './scripts/auth.js';
    import { guardButton } from './scripts/permissions.js';

    // تفعيل المكون الموحد (اختيار الفرع + الصلاحيات)
    initComponent("component", [
      { selector: ".btn.primary", section: "صيانة", action: "إضافة" },
      { selector: "#printBtn", section: "صيانة", action: "طباعة" }
    ]);

    const session = getSession();

    async function loadMaintenance() {
      const maintenance = await fetchJSON('data/maintenance.json');
      const tenants = await fetchJSON('data/tenants.json');
      const units = await fetchJSON('data/units.json');

      // فلترة طلبات الصيانة حسب الفرع
      const branchMaintenance = maintenance.filter(m => m.branch === session.branch);

      const tbody = document.querySelector('#maintenance-table tbody');
      tbody.innerHTML = branchMaintenance.map(m => {
        const tenant = tenants.find(t => t.id === m.tenantId);
        const unit = units.find(u => u.id === m.unitId);
        return `
          <tr>
            <td>${m.id}</td>
            <td>${unit ? unit.name : m.unitId}</td>
            <td>${tenant ? tenant.name : m.tenantId}</td>
            <td>${m.description}</td>
            <td>${m.date}</td>
            <td><span class="status ${statusClass(m.status)}">${m.status}</span></td>
            <td>
              <button class="btn warning">تحديث الحالة</button>
              <button class="btn danger">حذف</button>
            </td>
          </tr>
        `;
      }).join('');

      // تطبيق الصلاحيات على الأزرار
      setTimeout(() => {
        document.querySelectorAll('.btn.warning
